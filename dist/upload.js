!function(t,e){"function"==typeof define&&define.amd?define(["$"],e):"object"==typeof exports?module.exports=e():t.Upload=e(window.Zepto||window.jQuery||$)}(this,function(t){function e(){}return t.extend(e.prototype,{init:function(t){window.uploadCount=window.uploadCount||0,window.uploadCount++;var e=Math.random().toString().replace(".","");this.id="upload_"+e+window.uploadCount.toString(),this.settings=t,this.settings.iframe=!0,this.url=this.settings.url,this.name=this.settings.name||"files",this.target=this.settings.target,this.postTarget=this.settings.postTarget,this.autoPost="undefined"==typeof this.settings.autoPost?!0:this.settings.autoPost,this.createIframe(),this.createFile(),this.bindEvent(),this.bindFileChange()},createIframe:function(){if(this.frameId="iframe_upload",0==t("#"+this.frameId).length){var e='<iframe src="about:blank" id="'+this.frameId+'" name="'+this.frameId+'" width="0" height="0" frameborder="0"></iframe>';t("body").append(e)}this.frame=t("#"+this.frameId)},createFile:function(){var e=this;e.form&&e.form.remove(),e.form=t('<form method="post" ENCTYPE="multipart/form-data"><input type="file" style="position:absolute;top:0;left:0;width:1px;height:1px;opacity:0;" id="'+e.id+'" name="'+e.name+'"/></form>'),e.form.attr("target",e.frameId),e.form.css({height:0,widht:0,padding:0}),e.form.attr("action",e.url),t("body").append(e.form),e.fileInput=t("#"+e.id),this.bindFileChange()},postFrame:function(e,i,n){for(var s=e.value.split("."),a=s[s.length-1],o=this,r=this.settings.accept&&this.settings.accept.split(",")||[],l=!1,h=r.length-1;h>=0;h--){var f=new RegExp(r[h],"i");f.exec(a)&&(l=!0)}if(!l&&r.length){var u="文件格式错误,支持格式："+this.settings.accept;return t.alert?t.alert(u):alert(u),!1}return setTimeout(function(){o.form.submit()}),this.frame.off("load"),this.frame.on("load",function(){var e=t(t(this.contentWindow.document).find("body")),i=e.children()[0],s=e.html();i&&1==i.nodeType&&(s=i.innerHTML),"string"==typeof s&&"json"===o.settings.type&&(s=new Function("return "+s)()),o.settings.callback&&o.settings.callback.call(o,s,o.fileInput,o.name,o.target,n)}),o.createFile(),!0},touch:function(e,i){function n(t){return i.call(this,t)}var s;t(e).on("click",n),t(e).on("touchmove",function(t){s=!0}).on("touchend",function(t){if(t.preventDefault(),!s){var e=i.call(this,t,"touch");e||(t.preventDefault(),t.stopPropagation())}s=!1})},bindEvent:function(e){var i=this;this.touch(t(this.target),function(e,n){return t(this).parent().siblings().size()>=i.settings.max?i.settings.maxCallback&&i.settings.maxCallback(this):t(i.fileInput).trigger("click"),!1}),i.bindFileEvent(),this.postTarget&&this.touch(t(this.postTarget),function(t,e){i.args.length&&i.postFrame.apply(i,i.args)&&i.settings.startUpload&&i.settings.startUpload.apply(i,i.args)})},bindFileEvent:function(){t(this.fileInput).click(function(t){t.stopPropagation()})},bindFileChange:function(){var e=this;t(e.fileInput).off("change"),t(e.fileInput).on("change",function(t){var i=(t.target.files,"up_"+Math.random().toString().replace(".",""));e.args=[this,t,i],e.settings.selected&&e.settings.selected.call(this,this,t,i),e.settings.iframe&&e.autoPost&&e.postFrame(this,t,i)&&e.settings.startUpload&&e.settings.startUpload(e.fileInput,e.target,i)})}}),e});
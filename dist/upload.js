!function(t,i){"function"==typeof define&&define.amd?define(["$"],i):"object"==typeof exports?module.exports=i():t.Upload=i(window.Zepto||window.jQuery||$)}(this,function(t){function i(){}return t.extend(i.prototype,{init:function(t){window.uploadCount=window.uploadCount||0,window.uploadCount++;var i=Math.random().toString().replace(".","");this.id="upload_"+i+window.uploadCount.toString(),this.settings=t,this.settings.iframe=!0,this.url=this.settings.url,this.name=this.settings.name||"files",this.target=this.settings.target,this.createIframe(),this.createFile(),this.bindEvent(),this.bindFileChange()},createIframe:function(){if(this.frameId="iframe_upload",0==t("#"+this.frameId).length){var i='<iframe src="about:blank" id="'+this.frameId+'" name="'+this.frameId+'" width="0" height="0" frameborder="0"></iframe>';t("body").append(i)}this.frame=t("#"+this.frameId)},createFile:function(){var i=this;i.form&&i.form.remove(),i.form=t('<form method="post" ENCTYPE="multipart/form-data"><input type="file" style="position:absolute;top:0;left:0;width:1px;height:1px;opacity:0;" id="'+i.id+'" name="'+i.name+'"/></form>'),i.form.attr("target",i.frameId),i.form.css({height:0,widht:0,padding:0}),i.form.attr("action",i.url),t("body").append(i.form),i.fileInput=t("#"+i.id),this.bindFileChange()},postFrame:function(i,e,n){for(var a=i.value.split("."),o=a[a.length-1],r=this,s=this.settings.accept&&this.settings.accept.split(",")||[],f=!1,l=s.length-1;l>=0;l--){var h=new RegExp(s[l],"i");h.exec(o)&&(f=!0)}if(!f&&s.length){var c="文件格式错误,支持格式："+this.settings.accept;return t.alert?t.alert(c):alert(c),!1}return this.form.submit(),this.frame.off("load"),this.frame.on("load",function(){var i=t(t(this.contentWindow.document).find("body")),e=i.children()[0],a=i.html();e&&1==e.nodeType&&(a=e.innerHTML),r.settings.callback&&r.settings.callback(a,r.fileInput,r.name,r.target,n)}),r.createFile(),!0},touch:function(i,e){function n(t){return e.call(this,t)}var a;t(i).on("click",n),t(i).on("touchmove",function(t){a=!0}).on("touchend",function(t){if(t.preventDefault(),!a){var i=e.call(this,t,"touch");i||(t.preventDefault(),t.stopPropagation())}a=!1})},bindEvent:function(i){var e=this;this.touch(t(this.target),function(i,n){return t(this).parent().siblings().size()>=e.settings.max?e.settings.maxCallback&&e.settings.maxCallback(this):t(e.fileInput).trigger("click"),!1}),e.bindFileEvent()},bindFileEvent:function(){t(this.fileInput).click(function(t){t.stopPropagation()})},bindFileChange:function(){var i=this;t(i.fileInput).off("change"),t(i.fileInput).on("change",function(t){console.log(i);t.target.files;if(i.settings.iframe){var e="up_"+Math.random().toString().replace(".","");i.postFrame(this,t,e)&&i.settings.startUpload&&i.settings.startUpload(i.fileInput,i.target,e)}})}}),i});